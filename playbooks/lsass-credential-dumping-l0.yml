# RunbookPilot Reference Playbook: L0 LSASS Credential Dumping Investigation
# Schema Version: 1.0
# Automation Level: L0 (Manual - Recommendation Only)
#
# This playbook guides an analyst through the investigation of suspected
# LSASS credential dumping activity. At L0 all steps are read-only
# recommendations: data collection, enrichment, and notification.
# No containment or remediation actions are taken automatically.
#
# MITRE ATT&CK: T1003.001 - OS Credential Dumping: LSASS Memory
# Reference: https://attack.mitre.org/techniques/T1003/001/

runbook:
  id: "b7e3a1f0-4c29-4d8e-9f6a-1b2c3d4e5f60"
  version: "1.0"

  metadata:
    name: "T1003.001 - LSASS Credential Dumping Investigation"
    description: >
      L0 investigation playbook for suspected LSASS credential dumping.
      Retrieves the process tree around the suspicious LSASS access,
      correlates related events in the SIEM, hashes the offending binary,
      checks its reputation in VirusTotal, enriches extracted indicators,
      creates an investigation ticket, and notifies the assigned SOC
      analyst. All steps are read-only; no containment or remediation
      actions are executed at this automation level.
    author: "security-team@example.com"
    created: "2026-02-11T00:00:00Z"
    updated: "2026-02-11T00:00:00Z"
    tags:
      - "credential-access"
      - "lsass"
      - "credential-dumping"
      - "triage"
      - "windows"
    references:
      - "https://attack.mitre.org/techniques/T1003/001/"
      - "https://www.microsoft.com/en-us/security/blog/2022/10/05/detecting-and-preventing-lsass-credential-dumping-attacks/"
      - "https://redcanary.com/threat-detection-report/techniques/lsass-memory/"

  triggers:
    detection_sources:
      - "sigma"
      - "edr_alert"
    mitre_techniques:
      - "T1003.001"
    platforms:
      - "windows"
    severity:
      - "high"
      - "critical"

  config:
    automation_level: "L0"
    max_execution_time: 600
    requires_approval: false

  steps:
    # Step 1: Retrieve EDR process tree for suspicious LSASS access.
    # This is the foundation step. It pulls the process lineage around
    # the process that accessed lsass.exe so the analyst can understand
    # the full execution chain (grandparent -> parent -> child).
    - id: "step-01"
      name: "Get Process Tree for LSASS Access"
      description: >
        Query the EDR for the full process tree surrounding the process
        that accessed lsass.exe. Includes grandparent, parent, and child
        processes with command-line arguments, timestamps, user context,
        and integrity levels. This reveals whether the access came from
        a legitimate tool (e.g., AV scanner) or a known dumping utility
        (e.g., mimikatz, procdump, comsvcs.dll abuse).
      action: "retrieve_edr_data"
      executor: "edr"
      parameters:
        host: "{{ alert.host.name }}"
        query_type: "process_tree"
        process_id: "{{ alert.process.pid }}"
        target_process: "lsass.exe"
        include_children: true
        include_grandparent: true
        fields:
          - "process.name"
          - "process.pid"
          - "process.command_line"
          - "process.executable"
          - "process.parent.name"
          - "process.parent.pid"
          - "process.parent.command_line"
          - "user.name"
          - "user.domain"
          - "process.start"
        time_range: "1h"
      on_error: "halt"
      timeout: 60

    # Step 2: Query SIEM for correlated events on the same host.
    # Depends on step-01 to have the host context confirmed. Searches
    # for related credential-access, privilege-escalation, or lateral-
    # movement indicators on the same endpoint in the past hour.
    - id: "step-02"
      name: "Query SIEM for Related Events"
      description: >
        Search the SIEM for additional suspicious events on the same
        host within the last hour. Looks for correlated credential
        access attempts, privilege escalation events, new service
        installations, scheduled tasks, and lateral movement indicators
        that may form part of a broader attack chain.
      action: "query_siem"
      executor: "siem"
      parameters:
        query: >
          host.name:"{{ alert.host.name }}" AND
          (event.category:"authentication" OR
           event.category:"process" OR
           event.category:"intrusion_detection") AND
          (rule.name:*credential* OR rule.name:*privilege* OR
           rule.name:*lateral* OR rule.name:*mimikatz* OR
           rule.name:*procdump*)
        time_range: "1h"
        max_results: 100
        fields:
          - "event.action"
          - "event.category"
          - "rule.name"
          - "process.name"
          - "process.command_line"
          - "source.ip"
          - "destination.ip"
          - "user.name"
          - "@timestamp"
      depends_on:
        - "step-01"
      on_error: "continue"
      timeout: 45

    # Step 3: Calculate hash of the suspicious binary.
    # Depends on step-01 to identify the executable path. Computes
    # MD5 and SHA256 hashes for downstream reputation lookups.
    - id: "step-03"
      name: "Calculate Hash of Suspicious Binary"
      description: >
        Calculate MD5 and SHA256 hashes of the binary that accessed
        lsass.exe. The executable path is extracted from the EDR
        process tree data collected in step-01. These hashes are used
        for reputation lookups and IOC matching in subsequent steps.
      action: "calculate_hash"
      executor: "edr"
      parameters:
        host: "{{ alert.host.name }}"
        file_path: "{{ steps.step-01.output.process.executable }}"
        algorithms:
          - "md5"
          - "sha256"
      depends_on:
        - "step-01"
      on_error: "continue"
      timeout: 30

    # Step 4: Check binary hash reputation against VirusTotal.
    # Depends on step-03 for the computed hashes. Queries VT for
    # detection ratios, malware family names, and sandbox verdicts.
    - id: "step-04"
      name: "Check Binary Reputation via VirusTotal"
      description: >
        Submit the SHA256 hash of the suspicious binary to VirusTotal
        for reputation analysis. Returns detection ratio (e.g., 45/72),
        malware family classification, first-seen and last-seen dates,
        and any sandbox behavioral verdicts. A high detection ratio or
        known credential-dumping family confirms malicious intent.
      action: "check_reputation"
      executor: "threat_intel"
      parameters:
        indicator_type: "hash"
        indicator_value: "{{ steps.step-03.output.sha256 }}"
        sources:
          - "virustotal"
        include_sandbox_verdicts: true
        include_detection_names: true
      depends_on:
        - "step-03"
      on_error: "continue"
      timeout: 45

    # Step 5: Enrich all indicators from the alert.
    # Can run in parallel with step-04 since it depends only on step-01.
    # Enriches IPs, domains, hashes, and user accounts found in the alert.
    - id: "step-05"
      name: "Enrich Alert Indicators"
      description: >
        Enrich all indicators of compromise extracted from the original
        alert and the EDR process tree. This includes source and
        destination IP addresses, any domains contacted by the process,
        file hashes, and user account details. Cross-references against
        internal threat intel, open-source feeds, and historical
        incident data for prior sightings.
      action: "enrich_ioc"
      executor: "threat_intel"
      parameters:
        indicators:
          - type: "ip"
            value: "{{ alert.source.ip }}"
          - type: "hash"
            value: "{{ steps.step-03.output.sha256 | default: unknown }}"
          - type: "user"
            value: "{{ alert.user.name }}"
          - type: "hostname"
            value: "{{ alert.host.name }}"
        sources:
          - "virustotal"
          - "abuseipdb"
          - "internal_threat_intel"
        include_historical_sightings: true
      depends_on:
        - "step-01"
        - "step-03"
      on_error: "continue"
      timeout: 60

    # Step 6: Create investigation ticket with all findings.
    # Depends on steps 02, 04, and 05 so the ticket is comprehensive.
    - id: "step-06"
      name: "Create Investigation Ticket"
      description: >
        Create a SOC investigation ticket consolidating all findings
        from the previous steps. Includes the process tree analysis,
        correlated SIEM events, binary hash reputation, and enriched
        indicators. The ticket is assigned to the current analyst for
        manual review, triage decision, and potential escalation.
      action: "create_ticket"
      executor: "jira"
      parameters:
        project: "SOC"
        issue_type: "Investigation"
        summary: "LSASS Credential Dumping: {{ alert.host.name }} by {{ alert.user.name | default: unknown }}"
        description: |
          ## LSASS Credential Dumping Investigation

          **Alert Rule:** {{ alert.rule.name | default: Sigma T1003.001 }}
          **Severity:** {{ alert.event.severity | default: high }}
          **Analyst:** {{ context.analyst_email | default: unassigned }}
          **Execution ID:** {{ context.execution_id }}

          ---

          ### Host Details
          - **Hostname:** {{ alert.host.name }}
          - **Host IP:** {{ alert.host.ip }}
          - **OS:** {{ alert.host.os.name | default: Windows }}

          ### Process Tree (from EDR)
          - **Suspicious Process:** {{ steps.step-01.output.process.name }}
          - **PID:** {{ steps.step-01.output.process.pid }}
          - **Command Line:** {{ steps.step-01.output.process.command_line }}
          - **Executable:** {{ steps.step-01.output.process.executable }}
          - **Parent Process:** {{ steps.step-01.output.process.parent.name }} (PID {{ steps.step-01.output.process.parent.pid }})
          - **Parent Command Line:** {{ steps.step-01.output.process.parent.command_line }}
          - **User:** {{ steps.step-01.output.user.name }}@{{ steps.step-01.output.user.domain }}

          ### Binary Reputation
          - **SHA256:** {{ steps.step-03.output.sha256 | default: N/A }}
          - **VT Detection Ratio:** {{ steps.step-04.output.detection_ratio | default: N/A }}
          - **Malware Family:** {{ steps.step-04.output.malware_family | default: N/A }}
          - **First Seen:** {{ steps.step-04.output.first_seen | default: N/A }}

          ### Correlated SIEM Events
          - **Related Events Found:** {{ steps.step-02.output.total_hits | default: 0 }}
          - **Event Summary:** {{ steps.step-02.output.summary | default: No related events found }}

          ### Enriched Indicators
          - **IOC Summary:** {{ steps.step-05.output.summary | default: No enrichment data }}
          - **Historical Sightings:** {{ steps.step-05.output.historical_count | default: 0 }}

          ---

          **Recommended Actions (L0 Manual):**
          1. Review the process tree for known credential dumping tools (mimikatz, procdump, comsvcs.dll)
          2. Verify if the parent process is legitimate (e.g., AV or IT admin tool)
          3. Check if the user account is authorized for privileged operations
          4. Search for the same binary hash across all endpoints
          5. If confirmed malicious: isolate the host, reset compromised credentials
          6. Escalate to Tier 2/IR if VT detection ratio > 5 or known malware family
        priority: "{{ alert.event.severity >= 80 ? 'Critical' : 'High' }}"
        labels:
          - "credential-access"
          - "lsass"
          - "T1003.001"
          - "automated-triage"
        assignee: "{{ context.analyst_email | default: unassigned }}"
      depends_on:
        - "step-02"
        - "step-04"
        - "step-05"
      on_error: "continue"
      timeout: 30

    # Step 7: Notify the assigned SOC analyst.
    # Depends on step-06 so the notification can include the ticket link.
    - id: "step-07"
      name: "Notify SOC Analyst"
      description: >
        Send a notification to the assigned SOC analyst with a summary
        of the LSASS credential dumping investigation findings and a
        link to the investigation ticket. Notification is sent via the
        configured channel (Slack, Teams, PagerDuty, or email depending
        on the notification adapter configuration).
      action: "notify_analyst"
      executor: "notification"
      parameters:
        channel: "soc-alerts"
        message: >
          LSASS Credential Dumping detected on {{ alert.host.name }}.
          Process: {{ steps.step-01.output.process.name }}
          ({{ steps.step-01.output.process.command_line }}).
          VT Score: {{ steps.step-04.output.detection_ratio | default: pending }}.
          Ticket: {{ steps.step-06.output.ticket_url }}.
          Please review and triage.
        urgency: "high"
        mention: "{{ context.analyst_email | default: @soc-team }}"
      depends_on:
        - "step-06"
      on_error: "continue"
      timeout: 15
